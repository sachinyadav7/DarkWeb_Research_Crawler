<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dark Web Intelligence Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        /* (Your original CSS kept exactly as provided) */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 100%);
            color: #fff;
            overflow-x: hidden;
        }
        
        .dashboard-header {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 2px solid #00ff88;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff88;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 2rem;
        }
        
        .widget {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(0, 255, 136, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .widget:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 255, 136, 0.4);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.1);
        }
        
        .widget::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ff88, transparent);
            animation: scan 3s infinite;
        }
        
        @keyframes scan {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }
        
        .widget-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }
        
        .widget-icon {
            width: 24px;
            height: 24px;
            fill: #00ff88;
        }
        
        .widget-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #fff;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            grid-column: 1 / -1;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 4px solid #00ff88;
            transition: all 0.3s ease;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        
        .stat-label {
            color: #cccccc;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
        
        .risk-meter {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .risk-gauge {
            width: 200px;
            height: 200px;
            position: relative;
        }
        
        .alerts-list {
            max-height: 250px;
            overflow-y: auto;
        }
        
        .alert-item {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border-left: 4px solid #ff4444;
        }
        
        .alert-high {
            border-left-color: #ff4444;
        }
        
        .alert-medium {
            border-left-color: #ffaa00;
        }
        
        .alert-low {
            border-left-color: #00ff88;
        }
        
        .alert-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .alert-description {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .network-viz {
            height: 300px;
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .control-panel {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .control-button {
            background: linear-gradient(45deg, #00ff88, #00d4ff);
            color: #000;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .control-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }
        
        .control-button:active {
            transform: scale(0.95);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .data-table th,
        .data-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }
        
        .data-table th {
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .data-table tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }
        
        .risk-high {
            color: #ff4444;
        }
        
        .risk-medium {
            color: #ffaa00;
        }
        
        .risk-low {
            color: #00ff88;
        }
        
        @media (max-width:768px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
            .stat-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 255, 136, 0.3);
            border-top: 3px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        /* Toast for alerts */
        
        .toast {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.6);
            z-index: 2000;
            border-left: 6px solid #00ff88;
        }
    </style>
</head>

<body>
    <header class="dashboard-header">
        <div class="header-content">
            <div class="logo">üï∏Ô∏è Dark Web Intelligence</div>
            <div style="display:flex; gap:1rem; align-items:center;">
                <div style="margin-right:1rem;">
                    <form id="crawlForm" onsubmit="submitCrawl(event)" style="display:flex; gap:.5rem; align-items:center;">
                        <input id="crawlInput" name="url" placeholder="Enter URL or domain (example.com)" style="padding:.5rem .8rem; border-radius:8px; border:none; outline:none; width:360px; max-width:44vw;" />
                        <button class="control-button" type="submit" style="padding:.45rem .8rem; font-size:.9rem;">Crawl</button>
                    </form>
                </div>

                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="systemStatus">System Active</span>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Statistics Overview -->
        <div class="widget stat-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalPages">0</div>
                <div class="stat-label">Pages Crawled</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="highRiskPages">0</div>
                <div class="stat-label">High Risk Pages</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="entitiesExtracted">0</div>
                <div class="stat-label">Entities Extracted</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeAlerts">0</div>
                <div class="stat-label">Active Alerts</div>
            </div>
        </div>

        <!-- Risk Assessment -->
        <div class="widget">
            <div class="widget-header">
                <svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1M12 7C13.11 7 14 7.9 14 9C14 10.11 13.11 11 12 11C10.9 11 10 10.11 10 9C10 7.9 10.9 7 12 7M18 9C18 10.71 17.54 12.26 16.78 13.63L13.63 16.78C12.26 17.54 10.71 18 9 18V16C10.21 16 11.39 15.71 12.46 15.18L15.18 12.46C15.71 11.39 16 10.21 16 9"/></svg>
                <h2 class="widget-title">Risk Assessment</h2>
            </div>
            <div class="risk-meter">
                <div class="risk-gauge">
                    <canvas id="riskGauge" width="200" height="200"></canvas>
                </div>
                <div id="riskLevel" class="stat-number">LOW</div>
                <div style="font-size:0.9rem; color:#aaa; margin-top:.5rem;">Average risk across crawled pages</div>
            </div>
        </div>

        <!-- Activity Timeline -->
        <div class="widget">
            <div class="widget-header">
                <svg class="widget-icon" viewBox="0 0 24 24"><path d="M15,13H16.5V15.82L18.94,17.23L18.19,18.53L15,16.69V13M19,8H5V19H9.67C9.24,18.09 9,17.07 9,16A7,7 0 0,1 16,9C17.07,9 18.09,9.24 19,9.67V8M5,21C3.89,21 3,20.1 3,19V5C3,3.89 3.89,3 5,3H6V1H8V3H16V1H18V3H19A2,2 0 0,1 21,5V11.1C22.24,12.36 23,14.09 23,16A7,7 0 0,1 16,23C14.09,23 12.36,22.24 11.1,21H5M16,11.15A4.85,4.85 0 0,0 11.15,16C11.15,18.68 13.32,20.85 16,20.85A4.85,4.85 0 0,0 20.85,16C20.85,13.32 18.68,11.15 16,11.15Z"/></svg>
                <h2 class="widget-title">Activity Timeline</h2>
            </div>
            <div class="chart-container">
                <canvas id="activityChart"></canvas>
            </div>
        </div>

        <!-- Content Classification -->
        <div class="widget">
            <div class="widget-header">
                <svg class="widget-icon" viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z"/></svg>
                <h2 class="widget-title">Content Classification</h2>
            </div>
            <div class="chart-container">
                <canvas id="classificationChart"></canvas>
            </div>
        </div>

        <!-- Real-time Alerts -->
        <div class="widget">
            <div class="widget-header">
                <svg class="widget-icon" viewBox="0 0 24 24"><path d="M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z"/></svg>
                <h2 class="widget-title">Real-time Alerts</h2>
            </div>
            <div class="control-panel">
                <button class="control-button" onclick="refreshAlerts()">Refresh</button>
                <button class="control-button" onclick="clearAlerts()">Clear All</button>
                <div style="margin-left:auto; font-size:.85rem; color:#aaa;">Crawling: <span id="currentlyCrawling">0</span></div>
            </div>
            <div class="alerts-list" id="alertsList">
                <div style="text-align:center; color:#888; padding:2rem;">No active alerts</div>
            </div>
        </div>

        <!-- Network Visualization -->
        <div class="widget">
            <div class="widget-header">
                <svg class="widget-icon" viewBox="0 0 24 24"><path d="M17,20.5C17,21.3 16.3,22 15.5,22C14.7,22 14,21.3 14,20.5C14,19.7 14.7,19 15.5,19C16.3,19 17,19.7 17,20.5M2.5,4C3.3,4 4,4.7 4,5.5C4,6.3 3.3,7 2.5,7C1.7,7 1,6.3 1,5.5C1,4.7 1.7,4 2.5,4M9,12C9.8,12 10.5,12.7 10.5,13.5C10.5,14.3 9.8,15 9,15C8.2,15 7.5,14.3 7.5,13.5C7.5,12.7 8.2,12 9,12M6.5,10C7.3,10 8,10.7 8,11.5C8,12.3 7.3,13 6.5,13C5.7,13 5,12.3 5,11.5C5,10.7 5.7,10 6.5,10M12,6C12.8,6 13.5,6.7 13.5,7.5C13.5,8.3 12.8,9 12,9C11.2,9 10.5,8.3 10.5,7.5C10.5,6.7 11.2,6 12,6M21,9C21.8,9 22.5,9.7 22.5,10.5C22.5,11.3 21.8,12 21,12C20.2,12 19.5,11.3 19.5,10.5C19.5,9.7 20.2,9 21,9M19,6C19.8,6 20.5,6.7 20.5,7.5C20.5,8.3 19.8,9 19,9C18.2,9 17.5,8.3 17.5,7.5C17.5,6.7 18.2,6 19,6"/></svg>
                <h2 class="widget-title">Network Visualization</h2>
            </div>
            <div class="network-viz" id="networkViz"></div>
        </div>

        <!-- Threat Intelligence Table -->
        <div class="widget" style="grid-column:1 / -1;">
            <div class="widget-header">
                <svg class="widget-icon" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
                <h2 class="widget-title">Threat Intelligence Summary</h2>
            </div>
            <div class="control-panel">
                <button class="control-button" onclick="exportReport()">üìä Export Report</button>
                <button class="control-button" onclick="refreshData()">üîÑ Refresh Data</button>
                <button class="control-button" onclick="runAnalysis()">üîç Run Analysis</button>
            </div>

            <table class="data-table" id="threatTable">
                <thead>
                    <tr>
                        <th>URL</th>
                        <th>Risk Level</th>
                        <th>Classification</th>
                        <th>Entities Found</th>
                        <th>Last Analyzed</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="threatTableBody">
                    <tr>
                        <td colspan="6" style="text-align:center; color:#888;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // BASE_URL is same origin - Flask serves endpoints at '/'
        const BASE_URL = '';

        // Helper: map backend results -> table rows + stats
        async function fetchResultsJson() {
            try {
                const res = await fetch(`${BASE_URL}/results_json`);
                if (!res.ok) throw new Error('Failed to fetch results_json');
                return await res.json();
            } catch (e) {
                console.error(e);
                return {};
            }
        }

        async function fetchCrawledUrls() {
            try {
                const res = await fetch(`${BASE_URL}/crawled_urls`);
                if (!res.ok) throw new Error('Failed to fetch crawled_urls');
                return await res.json();
            } catch (e) {
                console.error(e);
                return {
                    crawled_urls: []
                };
            }
        }

        async function fetchCurrentlyCrawling() {
            try {
                const res = await fetch(`${BASE_URL}/currently_crawling`);
                if (!res.ok) return {
                    currently_crawling: []
                };
                return await res.json();
            } catch (e) {
                console.error(e);
                return {
                    currently_crawling: []
                };
            }
        }

        async function fetchGraph() {
            try {
                const res = await fetch(`${BASE_URL}/graph`);
                if (!res.ok) throw new Error('Failed to fetch graph');
                return await res.json();
            } catch (e) {
                console.error(e);
                return {
                    nodes: [],
                    edges: []
                };
            }
        }

        // Transform server results into arrays for UI
        function transformResults(resultsJson) {
            // resultsJson is { url1: { risk_level, classification, entities, last_analyzed, links:[...] }, ...}
            const rows = [];
            let totalEntities = 0;
            let totalPages = 0;
            let highRiskCount = 0;
            for (const url in resultsJson) {
                if (!Object.prototype.hasOwnProperty.call(resultsJson, url)) continue;
                const r = resultsJson[url];
                const entitiesCount = (r.entities && ((r.entities.emails || []).length + (r.entities.ips || []).length + (r.entities.domains || []).length)) || 0;
                rows.push({
                    url: url,
                    riskLevel: r.risk_level || 'Low',
                    classification: r.classification || '',
                    entities: entitiesCount,
                    lastAnalyzed: r.last_analyzed || '',
                    links: r.links || []
                });
                totalEntities += entitiesCount;
                totalPages += 1;
                if ((r.risk_level || '').toLowerCase() === 'high') highRiskCount++;
            }
            return {
                rows,
                totals: {
                    totalEntities,
                    totalPages,
                    highRiskCount
                }
            };
        }

        // Charts & UI managers (reuse your earlier ChartManager + UIManager logic but pulling real data)
        let charts = {
            activity: null,
            classification: null
        };

        function createActivityChart(data) {
            const ctx = document.getElementById('activityChart').getContext('2d');
            if (charts.activity) charts.activity.destroy();
            charts.activity = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'Pages Crawled',
                        data: data.map(d => d.crawled),
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0,255,136,0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Pages Analyzed',
                        data: data.map(d => d.analyzed),
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0,212,255,0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Alerts Generated',
                        data: data.map(d => d.alerts),
                        borderColor: '#ff4444',
                        backgroundColor: 'rgba(255,68,68,0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        }
                    }
                }
            });
        }

        function createClassificationChart(obj) {
            const ctx = document.getElementById('classificationChart').getContext('2d');
            if (charts.classification) charts.classification.destroy();
            const labels = Object.keys(obj);
            const values = Object.values(obj);
            charts.classification = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#00ff88', '#00d4ff', '#ffaa00', '#ff4444', '#9966ff', '#ff6699']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff'
                            }
                        }
                    }
                }
            });
        }

        function createRiskGauge(riskScore) {
            const canvas = document.getElementById('riskGauge');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2,
                centerY = canvas.height / 2,
                radius = 80;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, Math.PI, 2 * Math.PI);
            ctx.lineWidth = 20;
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.stroke();
            const riskAngle = Math.PI + (riskScore * Math.PI);
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, Math.PI, riskAngle);
            ctx.lineWidth = 20;
            if (riskScore < 0.3) {
                ctx.strokeStyle = '#00ff88';
                document.getElementById('riskLevel').textContent = 'LOW';
            } else if (riskScore < 0.7) {
                ctx.strokeStyle = '#ffaa00';
                document.getElementById('riskLevel').textContent = 'MEDIUM';
            } else {
                ctx.strokeStyle = '#ff4444';
                document.getElementById('riskLevel').textContent = 'HIGH';
            }
            ctx.stroke();
            const needleAngle = riskAngle;
            const needleLength = radius - 10;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(centerX + Math.cos(needleAngle) * needleLength, centerY + Math.sin(needleAngle) * needleLength);
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#fff';
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
            ctx.fillStyle = '#fff';
            ctx.fill();
        }

        // Network visualization: fetch /graph and render
        async function renderNetwork() {
            const container = document.getElementById('networkViz');
            container.innerHTML = '';
            const graph = await fetchGraph();
            const width = container.offsetWidth;
            const height = 300;
            const svg = d3.select(container).append('svg').attr('width', width).attr('height', height);

            // compact nodes list
            const nodesMap = new Map();
            (graph.nodes || []).forEach(n => nodesMap.set(n.id || n, {
                id: n.id || n
            }));
            (graph.edges || []).forEach(e => {
                nodesMap.set(e.source, nodesMap.get(e.source) || {
                    id: e.source
                });
                nodesMap.set(e.target, nodesMap.get(e.target) || {
                    id: e.target
                });
            });

            const nodes = Array.from(nodesMap.values());
            const links = (graph.edges || []).map(e => ({
                source: e.source,
                target: e.target
            }));

            const color = d3.scaleOrdinal().domain([0, 1, 2, 3, 4]).range(['#00ff88', '#00d4ff', '#ffaa00', '#ff6699', '#9966ff']);

            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(80))
                .force('charge', d3.forceManyBody().strength(-120))
                .force('center', d3.forceCenter(width / 2, height / 2));

            const link = svg.append('g').selectAll('line').data(links).enter().append('line').attr('stroke', '#666').attr('stroke-opacity', 0.6).attr('stroke-width', 1.5);
            const node = svg.append('g').selectAll('circle').data(nodes).enter().append('circle').attr('r', d => Math.max(4, Math.min(18, (String(d.id).length % 12) + 6))).attr('fill', (d, i) => color(i % 5)).attr('stroke', '#fff').attr('stroke-width', 1.2).call(drag(simulation));
            const labels = svg.append('g').selectAll('text').data(nodes).enter().append('text').text(d => shortLabel(d.id)).attr('font-size', 9).attr('fill', '#fff').attr('text-anchor', 'middle').attr('dy', 3);

            simulation.on('tick', () => {
                link.attr('x1', d => d.source.x).attr('y1', d => d.source.y).attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                node.attr('cx', d => d.x).attr('cy', d => d.y);
                labels.attr('x', d => d.x).attr('y', d => d.y);
            });

            function shortLabel(id) {
                try {
                    const u = new URL(id);
                    return u.hostname.length > 18 ? u.hostname.slice(0, 15) + '...' : u.hostname;
                } catch (e) {
                    return String(id).length > 18 ? String(id).slice(0, 15) + '...' : String(id);
                }
            }

            function drag(sim) {
                return d3.drag()
                    .on('start', (event, d) => {
                        if (!event.active) sim.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    })
                    .on('drag', (event, d) => {
                        d.fx = event.x;
                        d.fy = event.y;
                    })
                    .on('end', (event, d) => {
                        if (!event.active) sim.alphaTarget(0);
                        d.fx = null;
                        d.fy = null;
                    });
            }
        }

        // Fill threat table and stats
        async function refreshData() {
            // fetch data
            const [resultsJson, crawledUrlsRes, currently] = await Promise.all([fetchResultsJson(), fetchCrawledUrls(), fetchCurrentlyCrawling()]);
            const transformed = transformResults(resultsJson);
            const rows = transformed.rows;
            // Table
            const tbody = document.getElementById('threatTableBody');
            tbody.innerHTML = '';
            if (rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#888;">No data available</td></tr>`;
            } else {
                rows.sort((a, b) => (a.riskLevel === 'High' ? -1 : 1) - (b.riskLevel === 'High' ? -1 : 1));
                rows.forEach(r => {
                    const tr = document.createElement('tr');
                    const riskClass = r.riskLevel.toLowerCase() === 'high' ? 'risk-high' : r.riskLevel.toLowerCase() === 'medium' ? 'risk-medium' : 'risk-low';
                    tr.innerHTML = `<td><a href="#" onclick="openAnalysis('${encodeURIComponent(r.url)}'); return false;" style="color:#fff">${r.url}</a></td>
                                    <td><span class="${riskClass}">${r.riskLevel}</span></td>
                                    <td>${escapeHtml(r.classification)}</td>
                                    <td>${r.entities}</td>
                                    <td>${r.lastAnalyzed}</td>
                                    <td><button class="control-button" style="padding:.3rem .8rem; font-size:.8rem;" onclick="openAnalysis('${encodeURIComponent(r.url)}')">View</button></td>`;
                    tbody.appendChild(tr);
                });
            }

            // Stats
            document.getElementById('totalPages').textContent = transformed.totals.totalPages.toLocaleString();
            document.getElementById('highRiskPages').textContent = transformed.totals.highRiskCount.toLocaleString();
            document.getElementById('entitiesExtracted').textContent = transformed.totals.totalEntities.toLocaleString();
            // active alerts from SSE maintained separately (or use a fallback)
            document.getElementById('currentlyCrawling').textContent = (currently.currently_crawling || []).length;

            // Activity + Classification: build sample activity/classification based on crawled_urls or generate if empty
            let activityData = [];
            if (crawledUrlsRes.crawled_urls && crawledUrlsRes.crawled_urls.length) {
                // generate last 7 days activity with counts based on totalPages
                const totalPages = transformed.totals.totalPages || crawledUrlsRes.crawled_urls.length;
                for (let i = 6; i >= 0; i--) {
                    const dt = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
                    activityData.push({
                        date: dt.toLocaleDateString(),
                        crawled: Math.max(0, Math.round(totalPages / 7 + (Math.random() - 0.5) * 5)),
                        analyzed: Math.max(0, Math.round(totalPages / 7 + (Math.random() - 0.5) * 4)),
                        alerts: Math.round(Math.random() * 3)
                    });
                }
            } else {
                for (let i = 6; i >= 0; i--) {
                    const dt = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
                    activityData.push({
                        date: dt.toLocaleDateString(),
                        crawled: Math.floor(Math.random() * 50) + 10,
                        analyzed: Math.floor(Math.random() * 40) + 8,
                        alerts: Math.floor(Math.random() * 6)
                    });
                }
            }
            createActivityChart(activityData);

            // classification - derive simple counts from table classifications
            const classificationCounts = {};
            rows.forEach(r => {
                const key = r.classification || 'Unknown';
                classificationCounts[key] = (classificationCounts[key] || 0) + 1;
            });
            // ensure some labels exist
            if (Object.keys(classificationCounts).length === 0) {
                Object.assign(classificationCounts, {
                    'Research': 10,
                    'Marketplace': 6,
                    'Privacy Tools': 4,
                    'Suspicious': 2
                });
            }
            createClassificationChart(classificationCounts);

            // Risk gauge: average score from High/Medium/Low
            const riskScore = rows.length ? (rows.reduce((acc, r) => acc + (r.riskLevel === 'High' ? 0.9 : r.riskLevel === 'Medium' ? 0.5 : 0.1), 0) / rows.length) : 0.12;
            createRiskGauge(riskScore);

            // network visualization
            renderNetwork();
        }

        // SSE: listen for server events
        let alertsStore = [];

        function initSSE() {
            try {
                const es = new EventSource(`${BASE_URL}/events`);
                es.onmessage = function(e) {
                    try {
                        const payload = JSON.parse(e.data);
                        // payload is {url, risk, classification, time}
                        const alertObj = {
                            title: `Risk: ${payload.risk}`,
                            level: payload.risk.toLowerCase(),
                            description: `${payload.classification} detected at ${payload.time}`,
                            timestamp: new Date(payload.time).toLocaleString()
                        };
                        alertsStore.unshift(alertObj);
                        if (alertsStore.length > 50) alertsStore.length = 50;
                        renderAlerts();
                        // toast
                        showToast(`${payload.classification} - ${payload.risk} - ${payload.url}`);
                        // update active alerts count
                        document.getElementById('activeAlerts').textContent = alertsStore.length;
                    } catch (err) {
                        console.error('Invalid event data', err);
                    }
                };
                es.onerror = function(err) {
                    console.warn('SSE error', err);
                    es.close();
                    setTimeout(initSSE, 5000);
                };
            } catch (e) {
                console.warn('SSE not available', e);
            }
        }

        function renderAlerts() {
            const alertsList = document.getElementById('alertsList');
            alertsList.innerHTML = '';
            if (alertsStore.length === 0) {
                alertsList.innerHTML = '<div style="text-align:center; color:#888; padding:2rem;">No active alerts</div>';
                document.getElementById('activeAlerts').textContent = '0';
                return;
            }
            alertsStore.forEach(a => {
                const item = document.createElement('div');
                item.className = `alert-item alert-${a.level}`;
                item.innerHTML = `<div class="alert-title">${escapeHtml(a.title)}</div><div class="alert-description">${escapeHtml(a.description)}</div><div style="font-size:.8rem; color:#888; margin-top:.5rem;">${escapeHtml(a.timestamp)}</div>`;
                alertsList.appendChild(item);
            });
            document.getElementById('activeAlerts').textContent = alertsStore.length;
        }

        // Crawl form handler - calls /crawl, shows feedback and refreshes table when done
        async function submitCrawl(e) {
            e.preventDefault();
            const val = document.getElementById('crawlInput').value.trim();
            if (!val) return alert('Enter a URL or domain to crawl.');
            const payload = {
                url: val
            };
            const btn = e.target.querySelector('button');
            const original = btn.textContent;
            btn.textContent = 'Crawling...';
            btn.disabled = true;
            try {
                const res = await fetch(`${BASE_URL}/crawl`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                const j = await res.json();
                if (!res.ok) {
                    alert('Crawl error: ' + (j.error || JSON.stringify(j)));
                } else {
                    // refresh table so new crawl appears
                    await refreshData();
                    showToast(`Crawl completed: ${j.url} (${j.risk_level})`);
                }
            } catch (err) {
                console.error(err);
                alert('Crawl request failed: ' + err.message);
            } finally {
                btn.textContent = original;
                btn.disabled = false;
            }
        }

        function refreshAlerts() {
            renderAlerts();
        }

        function clearAlerts() {
            alertsStore = [];
            renderAlerts();
        }

        // "View" action - open a popup or new tab showing details. We'll open the seed URL row in a new tab and attempt to show last analyzed.
        function openAnalysis(encodedUrl) {
            const url = decodeURIComponent(encodedUrl);
            // open a new tab showing `/search?q=<url>` which triggers auto-crawl if not present
            const searchUrl = `/search?q=${encodeURIComponent(url)}`;
            window.open(searchUrl, '_blank');
        }

        function escapeHtml(text) {
            if (!text && text !== 0) return '';
            return String(text).replace(/[&<>"'`=\/]/g, function(s) {
                return ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;',
                    '/': '&#x2F;',
                    '`': '&#x60;',
                    '=': '&#x3D;'
                })[s];
            });
        }

        // Toast
        function showToast(msg, duration = 4000) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => {
                t.style.opacity = '0';
                setTimeout(() => t.remove(), 400);
            }, duration);
        }

        function runAnalysis() {
            showToast('Triggering analysis: For now, this is a manual frontend action. Use /crawl or /crawl_batch to analyze URLs.');
        }

        function exportReport() {
            // Gather visible data and export to JSON
            (async() => {
                const res = await fetchResultsJson();
                const filename = `intel_report_${new Date().toISOString().split('T')[0]}.json`;
                const blob = new Blob([JSON.stringify(res, null, 2)], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            })();
        }

        // small helper to seed initial fake charts when no real data
        function sampleActivityData() {
            const arr = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
                arr.push({
                    date: d.toLocaleDateString(),
                    crawled: Math.floor(Math.random() * 40) + 10,
                    analyzed: Math.floor(Math.random() * 30) + 10,
                    alerts: Math.floor(Math.random() * 6)
                });
            }
            return arr;
        }

        // Init on load
        document.addEventListener('DOMContentLoaded', async() => {
            // initialize SSE first
            initSSE();
            // initial draws
            createActivityChart(sampleActivityData());
            createClassificationChart({
                'Research': 10,
                'Marketplace': 6,
                'Privacy Tools': 4,
                'Suspicious': 2
            });
            createRiskGauge(0.12);
            // load real data
            await refreshData();
            // periodically refresh
            setInterval(refreshData, 30000);
        });
    </script>
</body>

</html>